# NX Release Workflow
# Triggered when tags matching v*.*.* are pushed
# Handles both regular releases (v1.0.0) and pre-releases (v1.0.0-dev.0)
name: Release & Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to release (e.g., v7.0.0-dev.1)'
        required: true
        type: string
      deploy_docs:
        description: 'Deploy documentation to GitHub Pages'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Create GitHub releases
      id-token: write # NPM provenance
      pages: write # Deploy GitHub Pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Install dependencies
        run: npm ci

      - name: Determine release type
        id: release-type
        env:
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_DEPLOY_DOCS: ${{ inputs.deploy_docs }}
        run: |
          # Get tag from workflow input or git ref
          if [ -n "$INPUT_TAG" ]; then
            TAG="$INPUT_TAG"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

          if [[ "$TAG" == *"-dev"* ]]; then
            echo "type=prerelease" >> $GITHUB_OUTPUT
            echo "npm_tag=dev" >> $GITHUB_OUTPUT
          else
            echo "type=release" >> $GITHUB_OUTPUT
            echo "npm_tag=latest" >> $GITHUB_OUTPUT
          fi

          # Get the commit message for the tag
          COMMIT_MESSAGE=$(git tag -l --format='%(contents:subject)' "$TAG" || git log -1 --format=%s "$TAG")
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT

          # Determine if docs should be deployed
          # Priority: workflow input > commit message marker > release type
          if [ "$INPUT_DEPLOY_DOCS" = "true" ]; then
            echo "deploy_docs=true" >> $GITHUB_OUTPUT
            echo "ðŸ“š Docs deployment: enabled via workflow input"
          elif [[ "$COMMIT_MESSAGE" == *"(+docs)"* ]]; then
            echo "deploy_docs=true" >> $GITHUB_OUTPUT
            echo "ðŸ“š Docs deployment: enabled via commit message marker (+docs)"
          elif [[ "$TAG" != *"-dev"* ]]; then
            # Auto-deploy docs for regular releases
            echo "deploy_docs=true" >> $GITHUB_OUTPUT
            echo "ðŸ“š Docs deployment: enabled for regular release"
          else
            echo "deploy_docs=false" >> $GITHUB_OUTPUT
            echo "ðŸ“š Docs deployment: skipped (pre-release without marker)"
          fi

      - name: Build library
        run: npx nx run rxdb:build --configuration=production

      - name: Publish to NPM
        working-directory: dist/packages/rxdb
        run: |
          npm pack
          npm publish --access public --tag ${{ steps.release-type.outputs.npm_tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.release-type.outputs.tag }}';
            const isPrerelease = tag.includes('-dev');

            // Get the changelog from the tag annotation or generate from commits
            let body = 'Release ' + tag;

            try {
              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: tag,
                body: body,
                draft: false,
                prerelease: isPrerelease
              });
              console.log('Created release:', release.data.html_url);
            } catch (error) {
              console.error('Error creating release:', error);
              throw error;
            }

      - name: Build & Deploy Demo
        if: steps.release-type.outputs.deploy_docs == 'true'
        run: |
          npm run build:demo
          npm run compodoc

      - name: Upload demo artifact
        if: steps.release-type.outputs.deploy_docs == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dist/demo'

      - name: Deploy to GitHub Pages
        if: steps.release-type.outputs.deploy_docs == 'true'
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
